<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paint Process Costing ‚Äì Single File</title>
  <style>
    :root {
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#94a3b8; /* slate-400 */
      --text:#e5e7eb; /* gray-200 */
      --accent:#22d3ee; /* cyan-400 */
      --ok:#4ade80; /* green-400 */
      --warn:#f59e0b; /* amber-500 */
      --danger:#f87171; /* red-400 */
      --border:#1f2937; /* gray-800 */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji"}
    h1,h2,h3{margin:.6rem 0 0.4rem}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
    label{display:block;color:var(--muted);font-size:12px;margin:6px 0 4px}
    input[type="number"], input[type="text"], select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0b1220;color:var(--text)}
    input[readonly]{opacity:.8}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap}
    button{cursor:pointer;border:1px solid var(--border);background:#0b1220;color:var(--text);padding:10px 14px;border-radius:10px}
    button.primary{background:linear-gradient(135deg, #0891b2, #22d3ee);color:#001018;border:0;font-weight:600}
    button.ghost{background:transparent}
    button.warn{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#231800;border:0;font-weight:600}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi .item{background:#0b1220;border:1px dashed var(--border);padding:12px;border-radius:12px}
    .kpi .item b{display:block;font-size:18px;margin-bottom:6px}
    code, pre{background:#0b1220;border:1px solid var(--border);border-radius:12px;padding:12px;display:block;overflow:auto;white-space:pre}
    .hint{color:var(--muted);font-size:12px}
    hr{border:0;border-top:1px solid var(--border);margin:12px 0}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#0b1220;color:var(--muted);font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{padding:8px 10px}
    thead th{font-size:12px;color:var(--muted);font-weight:600;text-align:left}
    tbody tr{background:#0b1220;border:1px solid var(--border)}
    tbody tr td{border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    tbody tr td:first-child{border-left:1px solid var(--border);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--border);border-top-right-radius:10px;border-bottom-right-radius:10px}
    .inline{display:flex;gap:8px;align-items:center}
    .right{display:flex;justify-content:flex-end;gap:8px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="container">
    <h1>üé® Paint Process Costing <span class="tag">Prototype ‚Äì Single HTML</span></h1>
    <p class="muted">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏µ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô/‡∏à‡∏¥‡πä‡∏Å ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡∏µ CT ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á ASCII layout ‡πÉ‡∏´‡πâ</p>

    <div class="grid cols-2">
      <!-- LEFT: INPUTS -->
      <section class="card">
        <h2>‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô (Part)</h2>
        <div class="row">
          <div>
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (Width, cm)</label>
            <input id="partW" type="number" min="0" step="0.01" value="10" />
          </div>
          <div>
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß (Height, cm)</label>
            <input id="partH" type="number" min="0" step="0.01" value="5" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (Depth, cm)</label>
            <input id="partD" type="number" min="0" step="0.01" value="2" />
          </div>
          <div>
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å</label>
            <select id="plastic">
              <option value="ABS" selected>ABS</option>
              <option value="PP">PP (‡∏ï‡πâ‡∏≠‡∏á‡∏û‡πà‡∏ô‡πÑ‡∏û‡∏£‡πÄ‡∏°‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô)</option>
              <option value="PC">PC</option>
              <option value="PS">PS</option>
              <option value="Other">‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß (Surface factor)</label>
            <input id="surfaceFactor" type="number" min="0.1" step="0.05" value="1.0" />
            <div class="hint">‡πÉ‡∏ä‡πâ‡∏Ñ‡∏π‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô (1.0 = ‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö)</div>
          </div>
          <div>
            <label>Loss / Lot (%)</label>
            <input id="lossPct" type="number" min="0" step="1" value="30" />
          </div>
        </div>
      </section>

      <section class="card">
        <h2>‡∏à‡∏¥‡πä‡∏Å (Jig) & ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á</h2>
        <div class="row">
          <div>
            <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏¥‡πä‡∏Å‡∏Å‡∏ß‡πâ‡∏≤‡∏á (cm)</label>
            <input id="jigW" type="number" min="1" step="0.1" value="50" />
          </div>
          <div>
            <label>‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏¥‡πä‡∏Å‡∏¢‡∏≤‡∏ß (cm)</label>
            <input id="jigH" type="number" min="1" step="0.1" value="60" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (cm)</label>
            <input id="gap" type="number" min="0" step="0.1" value="2" />
          </div>
          <div>
            <label>‡∏•‡∏≠‡∏á‡∏´‡∏°‡∏∏‡∏ô 90¬∞ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å orientation ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤)</label>
            <select id="tryRotate">
              <option value="yes" selected>Yes</option>
              <option value="no">No</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>Cycle Time ‡∏ï‡πà‡∏≠‡∏à‡∏¥‡πä‡∏Å (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
            <input id="ctPerJig" type="number" min="0" step="1" value="120" />
          </div>
          <div>
            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô</label>
            <input id="currency" type="text" value="‡∏ø" />
          </div>
        </div>
      </section>

      <!-- Paint DB -->
      <section class="card">
        <h2>‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏µ (Paint DB)</h2>
        <div class="grid cols-3">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ / ‡πÇ‡∏Ñ‡πâ‡∏î</label>
            <input id="db_name" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô Primer-PU-01" />
          </div>
          <div>
            <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
            <select id="db_type">
              <option value="Primer">Primer</option>
              <option value="Base" selected>Base</option>
              <option value="Top">Top</option>
              <option value="Clear">Clear</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div>
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡πà‡∏ß‡∏á‡∏à‡∏≥‡πÄ‡∏û‡∏≤‡∏∞ (g/cm¬≥)</label>
            <input id="db_sg" type="number" min="0.5" step="0.01" value="1.20" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°</label>
            <input id="db_price" type="number" min="0" step="0.01" value="500" />
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="btnbar">
              <button class="primary" onclick="addPaint()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ DB</button>
              <button class="ghost" onclick="clearDB()">‡∏•‡πâ‡∏≤‡∏á DB</button>
            </div>
          </div>
        </div>
        <div class="hint" id="db_count">‚Äì</div>
      </section>

      <!-- Layers -->
      <section class="card">
        <h2>‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡∏û‡πà‡∏ô (Layers)</h2>
        <div class="btnbar" style="margin-bottom:10px">
          <button class="ghost" onclick="presetDecoration()">Preset: ‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö‡∏•‡∏≤‡∏¢ (Base 20¬µm + Top 20¬µm)</button>
          <button class="ghost" onclick="addLayer()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</button>
          <button class="ghost" onclick="removeLastLayer()">‚Äì ‡∏•‡∏ö‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏ó‡πâ‡∏≤‡∏¢</button>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:22%">‡∏™‡∏µ</th>
              <th style="width:16%">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th style="width:16%">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (¬µm)</th>
              <th style="width:16%">SG (g/cm¬≥)</th>
              <th style="width:16%">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏Å‡∏Å.</th>
              <th>‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody id="layers"></tbody>
        </table>
        <div class="hint">‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å PP ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏°‡∏µ‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå Primer ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å</div>
      </section>

      <!-- RIGHT: OUTPUTS -->
      <section class="card">
        <h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Results)</h2>
        <div class="kpi">
          <div class="item"><b id="k_parts">‚Äì</b><span class="muted">‡∏ä‡∏¥‡πâ‡∏ô‡∏ï‡πà‡∏≠‡∏à‡∏¥‡πä‡∏Å</span></div>
          <div class="item"><b id="k_paintPart">‚Äì</b><span class="muted">‡∏™‡∏µ‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (g)</span></div>
          <div class="item"><b id="k_paintJig">‚Äì</b><span class="muted">‡∏™‡∏µ‡∏ï‡πà‡∏≠‡∏à‡∏¥‡πä‡∏Å (g)</span></div>
          <div class="item"><b id="k_ctJig">‚Äì</b><span class="muted">CT ‡∏ï‡πà‡∏≠‡∏à‡∏¥‡πä‡∏Å (s)</span></div>
          <div class="item"><b id="k_ctPart">‚Äì</b><span class="muted">CT ‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (s)</span></div>
          <div class="item"><b id="k_costPart">‚Äì</b><span class="muted">‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô</span></div>
        </div>
        <hr/>
        <div class="inline"><span class="muted">Orientation:</span> <span id="orientationTag" class="tag">‚Äì</span></div>
        <div class="inline"><span class="muted">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô:</span> <span id="costBreak" class="tag">‚Äì</span></div>
        <hr/>
        <div class="right btnbar">
          <button class="primary" onclick="calculate()">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (CALCULATE)</button>
          <button onclick="resetAll()">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
      </section>

      <section class="card" style="grid-column:1 / -1">
        <h2>ASCII Layout ‡∏ö‡∏ô‡∏à‡∏¥‡πä‡∏Å</h2>
        <pre id="ascii">(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå ‚Äì ‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì)</pre>
      </section>
    </div>
  </div>

  <script>
    // ------- Paint DB (localStorage) -------
    const PAINT_DB_KEY = 'paintDB_v1';
    function getDB(){
      try{ return JSON.parse(localStorage.getItem(PAINT_DB_KEY)) || []; }catch(e){ return []; }
    }
    function setDB(data){ localStorage.setItem(PAINT_DB_KEY, JSON.stringify(data)); refreshDBCount(); renderLayerRows(); }
    function refreshDBCount(){
      const db = getDB();
      document.getElementById('db_count').textContent = `‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡πÉ‡∏ô DB: ${db.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
    }
    function addPaint(){
      const name = document.getElementById('db_name').value.trim();
      const type = document.getElementById('db_type').value;
      const sg = parseFloat(document.getElementById('db_sg').value);
      const price = parseFloat(document.getElementById('db_price').value);
      if(!name || !isFinite(sg) || !isFinite(price)){
        alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ SG ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return;
      }
      const db = getDB();
      db.push({ id: crypto.randomUUID(), name, type, sg, price });
      setDB(db);
      document.getElementById('db_name').value = '';
    }
    function clearDB(){ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏µ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) setDB([]); }

    // ------- Layers -------
    function layerRowTemplate(layer){
      const db = getDB();
      const options = ['<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å DB ‚Äî</option>']
        .concat(db.map(p=>`<option value="${p.id}">${p.name}</option>`)).join('');
      return `<tr data-id="${layer.id}">
        <td>
          <select class="layer_paint">${options}</select>
        </td>
        <td>
          <input class="layer_type" type="text" value="${layer.type}" />
        </td>
        <td>
          <input class="layer_thk" type="number" min="0" step="0.1" value="${layer.thk}" />
        </td>
        <td>
          <input class="layer_sg" type="number" min="0.5" step="0.01" value="${layer.sg}" />
        </td>
        <td>
          <input class="layer_price" type="number" min="0" step="0.01" value="${layer.price}" />
        </td>
        <td>
          <button class="warn" onclick="removeLayerById('${layer.id}')">‡∏•‡∏ö</button>
        </td>
      </tr>`;
    }
    function renderLayerRows(){
      const tbody = document.getElementById('layers');
      tbody.innerHTML = LAYERS.map(layerRowTemplate).join('');
      // attach change handlers to pull data from DB when a paint is selected
      [...tbody.querySelectorAll('tr')].forEach(tr=>{
        const select = tr.querySelector('.layer_paint');
        select.addEventListener('change', () => {
          const id = select.value; if(!id) return;
          const p = getDB().find(x=>x.id===id); if(!p) return;
          tr.querySelector('.layer_type').value = p.type;
          tr.querySelector('.layer_sg').value = p.sg;
          tr.querySelector('.layer_price').value = p.price;
        });
      });
    }
    function addLayer(obj){
      LAYERS.push(Object.assign({ id: crypto.randomUUID(), type:'Base', thk:20, sg:1.20, price:500 }, obj||{}));
      renderLayerRows();
    }
    function removeLastLayer(){ LAYERS.pop(); renderLayerRows(); }
    function removeLayerById(id){
      const idx = LAYERS.findIndex(l=>l.id===id);
      if(idx>-1){ LAYERS.splice(idx,1); renderLayerRows(); }
    }
    function presetDecoration(){
      LAYERS.length = 0;
      addLayer({ type:'Base', thk:20 });
      addLayer({ type:'Top', thk:20 });
    }
    function ensurePrimerForPP(){
      const plastic = document.getElementById('plastic').value;
      const hasPrimer = LAYERS.some(l=>l.type.toLowerCase()==='primer');
      if(plastic==='PP' && !hasPrimer){
        LAYERS.unshift({ id: crypto.randomUUID(), type:'Primer', thk:10, sg:1.10, price:500 });
        renderLayerRows();
      }
    }

    // ------- Core Calculation -------
    function readNumber(id){ return parseFloat(document.getElementById(id).value); }

    function surfaceAreaRect(w,h,d, factor){
      // cm^2; factor adjusts for geometry complexity
      return 2*(w*h + w*d + h*d) * factor;
    }

    function partsPerJig(partW, partH, jigW, jigH, gap, tryRotate){
      // Require at least 'gap' margin on all four edges and between parts; same orientation across all parts.
      function fit(W,H,pw,ph){
        const availW = W - 2*gap; if(availW <= 0) return {cols:0, rows:0, count:0};
        const availH = H - 2*gap; if(availH <= 0) return {cols:0, rows:0, count:0};
        const cols = Math.floor((availW + gap) / (pw + gap));
        const rows = Math.floor((availH + gap) / (ph + gap));
        const count = Math.max(0, cols) * Math.max(0, rows);
        return {cols, rows, count};
      }
      const a = fit(jigW, jigH, partW, partH);
      if(!tryRotate){ return Object.assign(a, {rotated:false}); }
      const b = fit(jigW, jigH, partH, partW);
      if(b.count > a.count){ return Object.assign(b, {rotated:true}); }
      return Object.assign(a, {rotated:false});
    }

    function asciiLayout(cols, rows){
      if(cols<=0 || rows<=0) return '(‡∏ß‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Äì ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô)';
      const cellW = 4; // spacing between symbols (cosmetic)
      const innerW = cols*1 + (cols-1)*(cellW-1);
      const pad = 2;
      const line = '+'.padEnd(innerW + pad*2 + 1,'-') + '+';
      let out = '';
      out += line + '\n';
      for(let r=0;r<rows;r++){
        let row = '|'+ ' '.repeat(pad);
        for(let c=0;c<cols;c++){
          row += 'O';
          if(c<cols-1) row += ' '.repeat(cellW-1);
        }
        row += ' '.repeat(pad) + '|\n';
        // spacer line (visual) except last
        if(r<rows-1){
          out += row;
          out += '|' + ' '.repeat(innerW + pad*2) + '|\n';
        } else {
          out += row;
        }
      }
      out += line;
      return out;
    }

    function calculate(){
      ensurePrimerForPP();
      const w = readNumber('partW');
      const h = readNumber('partH');
      const d = readNumber('partD');
      const factor = readNumber('surfaceFactor');
      const jigW = readNumber('jigW');
      const jigH = readNumber('jigH');
      const gap = readNumber('gap');
      const tryRot = document.getElementById('tryRotate').value === 'yes';
      const ctJig = readNumber('ctPerJig');
      const currency = document.getElementById('currency').value || '‡∏ø';
      const lossPct = readNumber('lossPct')/100;

      // 1) Parts per jig (pattern orientation)
      const fit = partsPerJig(w, h, jigW, jigH, gap, tryRot);
      const parts = fit.count;

      // 2) Surface area (cm^2) per part
      const SA = surfaceAreaRect(w, h, d, factor);

      // 3) Paint per part by layers
      const tbody = document.getElementById('layers');
      const rows = [...tbody.querySelectorAll('tr')];
      let totalPaintPerPart_g = 0;
      let costPerPart = 0;
      let costBreak = [];

      function micronToCm(m){ return m*1e-4; }

      rows.forEach(tr=>{
        const type = tr.querySelector('.layer_type').value.trim();
        const thk = parseFloat(tr.querySelector('.layer_thk').value) || 0; // micron
        const sg  = parseFloat(tr.querySelector('.layer_sg').value) || 1.0; // g/cm3
        const priceKg = parseFloat(tr.querySelector('.layer_price').value) || 0; // per kg
        const vol_cm3 = SA * micronToCm(thk); // cm3
        const mass_g = vol_cm3 * sg; // g per part (ideal)
        const mass_withLoss_g = mass_g * (1 + lossPct);
        totalPaintPerPart_g += mass_withLoss_g;
        const cost = (mass_withLoss_g/1000) * priceKg; // ‡∏ø per part
        costPerPart += cost;
        costBreak.push(`${type}: ${(mass_withLoss_g).toFixed(3)} g / ${currency}${cost.toFixed(3)}`);
      });

      // 4) Aggregations
      const paintPerJig_g = totalPaintPerPart_g * parts;
      const ctPerPart = parts>0 ? (ctJig/parts) : 0;

      // 5) Output KPIs
      document.getElementById('k_parts').textContent = parts;
      document.getElementById('k_paintPart').textContent = totalPaintPerPart_g.toFixed(3);
      document.getElementById('k_paintJig').textContent = paintPerJig_g.toFixed(3);
      document.getElementById('k_ctJig').textContent = ctJig.toFixed(1);
      document.getElementById('k_ctPart').textContent = ctPerPart.toFixed(2);
      document.getElementById('k_costPart').textContent = `${currency}${costPerPart.toFixed(3)}`;
      document.getElementById('costBreak').textContent = costBreak.join(' | ');

      // 6) Orientation tag
      const tag = fit.rotated ? 'Rotated 90¬∞ (‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏´‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)' : 'Default (‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô‡∏´‡∏±‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô)';
      document.getElementById('orientationTag').textContent = tag;

      // 7) ASCII layout
      document.getElementById('ascii').textContent = asciiLayout(fit.cols, fit.rows) + `\n\nJig ${jigW} x ${jigH} cm | part ${fit.rotated?`${h}x${w}`:`${w}x${h}`} cm | gap ${gap} cm`;
    }

    function resetAll(){ localStorage.removeItem(PAINT_DB_KEY); location.reload(); }

    // --------- Bootstrap ---------
    const LAYERS = [];
    refreshDBCount();
    presetDecoration();

    document.getElementById('plastic').addEventListener('change', ensurePrimerForPP);
  </script>
</body>
</html>
