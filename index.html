<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre cost Analysis NPD</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #e0e6ed;
            min-height: 100vh;
            padding: 20px;
        }

        .header-nav {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .nav-link {
            color: #4fd1c7;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(79, 209, 199, 0.1);
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(79, 209, 199, 0.2);
            transform: translateY(-2px);
        }

        .user-info {
            color: #b0b8c4;
            font-size: 0.9rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .nav-links {
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            grid-column: 1 / -1;
            color: #4fd1c7;
            font-size: 2rem;
        }

        h2 {
            color: #4fd1c7;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(79, 209, 199, 0.3);
            padding-bottom: 5px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #b0b8c4;
            font-weight: 500;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #e0e6ed;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4fd1c7;
            box-shadow: 0 0 10px rgba(79, 209, 199, 0.3);
        }

        .input-row {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4fd1c7, #3b82f6);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .layers-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .layers-table th,
        .layers-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .layers-table th {
            background: rgba(79, 209, 199, 0.2);
            color: #4fd1c7;
            font-weight: 600;
        }

        .layers-table select,
        .layers-table input {
            padding: 5px;
            font-size: 12px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .kpi-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .kpi-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #4fd1c7;
            display: block;
        }

        .kpi-label {
            font-size: 0.9rem;
            color: #b0b8c4;
            margin-top: 5px;
        }

        .canvas-layout-container {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        #layoutCanvas {
            border: 2px solid rgba(79, 209, 199, 0.4);
            border-radius: 8px;
            background: #0a1929;
            max-width: 100%;
            height: auto;
        }

        .canvas-info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .breakdown {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .breakdown-item:last-child {
            border-bottom: none;
            font-weight: bold;
            color: #4fd1c7;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .results-section {
            grid-column: 1 / -1;
        }

        .cleaning-section {
            grid-column: 1 / -1;
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .consumables-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .consumables-table th,
        .consumables-table td {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .consumables-table th {
            background: rgba(245, 158, 11, 0.2);
            color: #fbbf24;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .process-clean-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #fbbf24;
        }

        .process-clean-item select {
            width: 250px;
            margin-left: 20px;
        }

        .preset-section {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            grid-column: 1 / -1;
        }

        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .preset-item {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .preset-item:hover {
            background: rgba(16, 185, 129, 0.2);
            border-color: #10b981;
        }

        .preset-item.selected {
            background: rgba(16, 185, 129, 0.3);
            border-color: #10b981;
        }

        .ct-breakdown {
            background: rgba(79, 209, 199, 0.1);
            border: 1px solid rgba(79, 209, 199, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .orientation-tag {
            display: inline-block;
            background: rgba(79, 209, 199, 0.2);
            color: #4fd1c7;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 5px 0;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: #b0b8c4;
            font-size: 0.9rem;
            grid-column: 1 / -1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: rgba(26, 26, 46, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid rgba(79, 209, 199, 0.3);
            padding-bottom: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            color: #e0e6ed;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
        }

        .process-breakdown {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .process-breakdown .kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .process-breakdown .kpi-item {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
        }

        .process-breakdown .kpi-value {
            color: #10b981;
        }

        @media print {
            * {
                visibility: hidden;
            }
            
            .print-section, .print-section * {
                visibility: visible;
            }
            
            .print-section {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                background: white;
                color: black;
                font-family: Arial, sans-serif;
                font-size: 10px;
                line-height: 1.2;
            }
            
            @page {
                size: A4;
                margin: 15mm;
            }
            
            .print-container {
                width: 210mm;
                padding: 5mm;
                box-sizing: border-box;
            }
            
            .print-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                border-bottom: 2px solid #000;
                padding-bottom: 8mm;
                margin-bottom: 8mm;
                page-break-inside: avoid;
            }
            
            .print-logo {
                width: 60px;
                height: 60px;
                object-fit: contain;
                border: 1px solid #333;
            }
            
            .print-company-info {
                text-align: center;
                flex: 1;
                margin: 0 10mm;
            }
            
            .print-company-info h1 {
                font-size: 16px;
                margin: 0 0 3px 0;
            }
            
            .print-company-info h2 {
                font-size: 12px;
                margin: 0 0 8px 0;
            }
            
            .part-specifications {
                display: flex;
                align-items: flex-start;
                gap: 10mm;
                page-break-inside: avoid;
                margin-bottom: 8mm;
            }
            
            .part-image-container {
                flex-shrink: 0;
                width: 80px;
                height: 80px;
                border: 1px solid #333;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .part-image {
                max-width: 78px;
                max-height: 78px;
                object-fit: contain;
            }
            
            .part-specs-table {
                flex: 1;
            }
            
            .print-section-title {
                background-color: #e6f3ff;
                font-weight: bold;
                padding: 2mm;
                border: 1px solid #000;
                margin: 5mm 0 2mm 0;
                font-size: 11px;
            }
            
            .print-table {
                width: 100%;
                border-collapse: collapse;
                margin: 3mm 0;
                font-size: 9px;
            }
            
            .print-table th,
            .print-table td {
                border: 1px solid #333;
                padding: 1.5mm;
                text-align: left;
                vertical-align: top;
            }
            
            .print-table th {
                background-color: #f0f0f0;
                font-weight: bold;
            }
            
            .cost-summary {
                background-color: #fff2cc;
                border: 2px solid #d6b656;
                padding: 3mm;
                margin: 3mm 0;
                text-align: center;
                page-break-inside: avoid;
            }
            
            .cost-summary h2 {
                margin: 0;
                font-size: 14px;
            }
            
            .page-break {
                page-break-before: always;
            }
            
            .compact-section {
                margin-bottom: 5mm;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <div class="header-nav">
        <div class="nav-links">
            <a href="index.html" class="nav-link">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
            <a href="paint-mixer.html" class="nav-link">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏µ‡∏ú‡∏™‡∏°</a>
            <a href="film-calculator.html" class="nav-link">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Film & Activator</a>
            <a href="cost-history.html" class="nav-link">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Cost ‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß</a>
            <a href="data-manager.html" class="nav-link">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
            <a href="login.html" class="nav-link">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</a>
        </div>
        <div class="user-info" id="userInfo">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</div>
    </div>

    <div class="container">
        <h1>Pre cost Analysis NPD</h1>
        
        <!-- Process Preset Selection -->
        <div class="card preset-section">
            <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô (Preset)</h2>
            <div class="checkbox-group">
                <input type="checkbox" id="usePreset">
                <label for="usePreset">‡πÉ‡∏ä‡πâ Preset (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</label>
            </div>
            
            <div id="presetOptions" style="display: none;">
                <div class="preset-grid">
                    <div class="preset-item" data-preset="paint-only">
                        <h3>1. ‡∏û‡πà‡∏ô‡∏™‡∏µ</h3>
                        <p>‡πÄ‡∏ä‡πá‡∏î ‚Üí ‡∏û‡πà‡∏ô‡πÄ‡∏ö‡∏™ ‚Üí ‡∏ï‡∏£‡∏ß‡∏à ‚Üí ‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                    <div class="preset-item" data-preset="decoration">
                        <h3>2. ‡∏ä‡∏∏‡∏ö‡∏•‡∏≤‡∏¢ (Transfer)</h3>
                        <p>‡πÄ‡∏ä‡πá‡∏î ‚Üí ‡∏û‡πà‡∏ô‡πÄ‡∏ö‡∏™ ‚Üí ‡∏ä‡∏∏‡∏ö‡∏•‡∏≤‡∏¢ ‚Üí ‡∏ó‡πá‡∏≠‡∏õ‡πÇ‡∏Ñ‡πâ‡∏ó ‚Üí ‡∏ï‡∏£‡∏ß‡∏à ‚Üí ‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                    <div class="preset-item" data-preset="decoration-2">
                        <h3>3. ‡∏ä‡∏∏‡∏ö‡∏•‡∏≤‡∏¢ 2 (Transfer 2)</h3>
                        <p>‡πÄ‡∏ä‡πá‡∏î ‚Üí ‡∏ä‡∏∏‡∏ö‡∏•‡∏≤‡∏¢ ‚Üí ‡∏ó‡πá‡∏≠‡∏õ‡πÇ‡∏Ñ‡πâ‡∏ó ‚Üí ‡∏ï‡∏£‡∏ß‡∏à ‚Üí ‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                    <div class="preset-item" data-preset="topcoat-only">
                        <h3>4. ‡∏ó‡πá‡∏≠‡∏õ‡πÇ‡∏Ñ‡πâ‡∏ó</h3>
                        <p>‡πÄ‡∏ä‡πá‡∏î ‚Üí ‡∏ó‡πá‡∏≠‡∏õ‡πÇ‡∏Ñ‡πâ‡∏ó ‚Üí ‡∏ï‡∏£‡∏ß‡∏à ‚Üí ‡∏Ç‡∏≤‡∏¢</p>
                    </div>
                </div>
                <div id="selectedPreset" style="display: none; text-align: center; margin-top: 15px;">
                    <span style="color: #10b981; font-weight: bold;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: <span id="selectedPresetName"></span></span>
                </div>
            </div>
        </div>

        <!-- Part Information -->
        <div class="card">
            <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô</h2>
            <div class="input-row">
                <div class="form-group">
                    <label for="partWidth">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á (cm)</label>
                    <input type="number" id="partWidth" step="0.1" value="10">
                </div>
                <div class="form-group">
                    <label for="partHeight">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (cm)</label>
                    <input type="number" id="partHeight" step="0.1" value="5">
                </div>
                <div class="form-group">
                    <label for="partDepth">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∂‡∏Å (cm)</label>
                    <input type="number" id="partDepth" step="0.1" value="2">
                </div>
            </div>
            
            <div class="form-group">
                <label for="plasticType">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å</label>
                <select id="plasticType">
                    <option value="ABS">ABS</option>
                    <option value="PP">PP (‡∏ï‡πâ‡∏≠‡∏á Primer)</option>
                    <option value="PC">PC</option>
                    <option value="PS">PS</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            
            <div class="input-row">
                <div class="form-group">
                    <label for="surfaceFactor">‡∏ï‡∏±‡∏ß‡∏Ñ‡∏π‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏ß</label>
                    <input type="number" id="surfaceFactor" step="0.1" value="10">
                </div>
                <div class="form-group">
                    <label for="lossPct">Loss per lot (%)</label>
                    <input type="number" id="lossPct" step="1" value="30">
                </div>
            </div>
            
            <div class="form-group">
                <label for="partImage">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)</label>
                <input type="file" id="partImage" accept="image/*">
                <img id="imagePreview" class="image-preview" style="display: none;">
            </div>
        </div>

        <!-- Jig & Layout -->
        <div class="card">
            <h2>Jig & Layout</h2>
            <div class="input-row">
                <div class="form-group">
                    <label for="jigWidth">Jig Width (cm)</label>
                    <input type="number" id="jigWidth" step="0.1" value="50">
                </div>
                <div class="form-group">
                    <label for="jigHeight">Jig Height (cm)</label>
                    <input type="number" id="jigHeight" step="0.1" value="60">
                </div>
            </div>
            
            <div class="input-row">
                <div class="form-group">
                    <label for="minGap">Min Gap (cm)</label>
                    <input type="number" id="minGap" step="0.1" value="2">
                </div>
                <div class="form-group">
                    <label for="cycleTime">Total Cycle Time per Jig (sec)</label>
                    <input type="number" id="cycleTime" step="1" value="120">
                </div>
            </div>
            
            <!-- CT Breakdown Section -->
            <div class="ct-breakdown">
                <h3 style="color: #4fd1c7; margin-bottom: 15px;">Cycle Time Breakdown</h3>
                <div class="input-row">
                    <div class="form-group">
                        <label for="ctCleanInput">CT ‡πÄ‡∏ä‡πá‡∏î (sec)</label>
                        <input type="number" id="ctCleanInput" step="1" value="15" min="0">
                    </div>
                    <div class="form-group">
                        <label for="ctBaseInput">CT ‡∏û‡πà‡∏ô Base (sec)</label>
                        <input type="number" id="ctBaseInput" step="1" value="60" min="0">
                    </div>
                </div>
                <div class="input-row">
                    <div class="form-group">
                        <label for="ctTopcoatInput">CT ‡∏û‡πà‡∏ô Topcoat (sec)</label>
                        <input type="number" id="ctTopcoatInput" step="1" value="45" min="0">
                    </div>
                    <div class="form-group">
                        <label for="ctInspectInput">CT ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (sec)</label>
                        <input type="number" id="ctInspectInput" step="1" value="20" min="0">
                    </div>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="autoCalcCT" checked>
                    <label for="autoCalcCT">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Total CT ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="tryRotate">
                <label for="tryRotate">Try Rotate 90¬∞</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="allowClipping">
                <label for="allowClipping">‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡πÄ‡∏•‡∏¢‡∏Ç‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô 50cm (‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏¢‡∏î‡πâ‡∏≤‡∏ô 60cm)</label>
            </div>

            <!-- Parts per Jig Calculation Mode -->
            <div class="form-group">
                <label>‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏ô Jig</label>
                <div class="checkbox-group">
                    <input type="radio" id="autoCalculate" name="jigCalculation" value="auto" checked>
                    <label for="autoCalculate">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</label>
                </div>
                <div class="checkbox-group">
                    <input type="radio" id="manualInput" name="jigCalculation" value="manual">
                    <label for="manualInput">‡∏õ‡πâ‡∏≠‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡πÄ‡∏≠‡∏á</label>
                </div>
                <div class="form-group" id="manualPartsGroup" style="display: none;">
                    <label for="manualPartsPerJig">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏¥‡πâ‡∏ô‡πÉ‡∏ô Jig</label>
                    <input type="number" id="manualPartsPerJig" min="1" value="1">
                </div>
            </div>
            
            <div class="form-group">
                <label for="currency">‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô</label>
                <input type="text" id="currency" value="‡∏ø" maxlength="3">
            </div>
        </div>

        <!-- Layers -->
        <div class="card">
            <h2>‡∏ä‡∏±‡πâ‡∏ô‡∏™‡∏µ (Layers)</h2>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="presetDecoration()">Preset Decoration</button>
                <button type="button" class="btn btn-secondary" onclick="addLayer()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå</button>
                <button type="button" class="btn btn-secondary" onclick="removeLastLayer()">- ‡∏•‡∏ö‡πÄ‡∏•‡πÄ‡∏¢‡∏≠‡∏£‡πå‡∏ó‡πâ‡∏≤‡∏¢</button>
            </div>
            
            <table class="layers-table">
                <thead>
                    <tr>
                        <th>‡∏™‡∏µ</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>‡∏£‡∏≤‡∏Ñ‡∏≤ Ready to use (‡∏ø/g)</th>
                        <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤ (¬µm)</th>
                    </tr>
                </thead>
                <tbody id="layersTable">
                </tbody>
            </table>
        </div>

        <!-- Enhanced Cleaning Materials -->
        <div class="card cleaning-section">
            <h2>‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</h2>
            
            <!-- Process-based cleaning -->
            <div class="cleaning-processes">
                <div class="process-clean-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="cleanNewWork" checked>
                        <label for="cleanNewWork"><strong>‡πÄ‡∏ä‡πá‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</strong> (20% ‡∏Ç‡∏≠‡∏á‡∏™‡∏µ‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô)</label>
                    </div>
                    <select id="cleanNewWorkAgent" style="margin-left: 20px; width: 250px;">
                        <option value="p700" selected>P700 (Main cleaner)</option>
                        <option value="pm">PM (Pre-cleaner)</option>
                        <option value="ipa">IPA (Isopropyl Alcohol)</option>
                        <option value="acetone">Acetone</option>
                        <option value="mek">MEK (Methyl Ethyl Ketone)</option>
                    </select>
                </div>

                <div class="process-clean-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="cleanBeforeBase">
                        <label for="cleanBeforeBase">‡πÄ‡∏ä‡πá‡∏î‡∏ó‡∏µ‡πà Process Base</label>
                    </div>
                    <select id="cleanBeforeBaseAgent" style="margin-left: 20px; width: 250px; display: none;">
                        <option value="p700" selected>P700 (Main cleaner)</option>
                        <option value="pm">PM (Pre-cleaner)</option>
                        <option value="ipa">IPA (Isopropyl Alcohol)</option>
                        <option value="acetone">Acetone</option>
                        <option value="mek">MEK (Methyl Ethyl Ketone)</option>
                    </select>
                </div>

                <div class="process-clean-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="cleanBeforeTopcoat">
                        <label for="cleanBeforeTopcoat">‡πÄ‡∏ä‡πá‡∏î‡∏ó‡∏µ‡πà Process Topcoat</label>
                    </div>
                    <select id="cleanBeforeTopcoatAgent" style="margin-left: 20px; width: 250px; display: none;">
                        <option value="p700" selected>P700 (Main cleaner)</option>
                        <option value="pm">PM (Pre-cleaner)</option>
                        <option value="ipa">IPA (Isopropyl Alcohol)</option>
                        <option value="acetone">Acetone</option>
                        <option value="mek">MEK (Methyl Ethyl Ketone)</option>
                    </select>
                </div>

                <div class="process-clean-item">
                    <div class="checkbox-group">
                        <input type="checkbox" id="cleanBeforeTF">
                        <label for="cleanBeforeTF">‡πÄ‡∏ä‡πá‡∏î‡∏ó‡∏µ‡πà Process T/F</label>
                    </div>
                    <select id="cleanBeforeTFAgent" style="margin-left: 20px; width: 250px; display: none;">
                        <option value="p700" selected>P700 (Main cleaner)</option>
                        <option value="pm">PM (Pre-cleaner)</option>
                        <option value="ipa">IPA (Isopropyl Alcohol)</option>
                        <option value="acetone">Acetone</option>
                        <option value="mek">MEK (Methyl Ethyl Ketone)</option>
                    </select>
                </div>
            </div>

            <!-- Cleaning agents pricing -->
            <div id="cleaningAgentsTable" style="margin-top: 20px;">
                <h3 style="color: #fbbf24; margin-bottom: 10px;">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î</h3>
                <table class="consumables-table">
                    <thead>
                        <tr><th>‡∏ô‡πâ‡∏≥‡∏¢‡∏≤</th><th>‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ø/g)</th><th>‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô (g/part)</th></tr>
                    </thead>
                    <tbody>
                        <tr><td>P700 (Main cleaner)</td><td><input type="number" id="priceP700" value="0.18" step="0.01" style="width: 80px;"></td><td><input type="number" id="amountP700" value="5.0" step="0.1" style="width: 80px;"></td></tr>
                        <tr><td>PM (Pre-cleaner)</td><td><input type="number" id="pricePM" value="0.15" step="0.01" style="width: 80px;"></td><td><input type="number" id="amountPM" value="5.0" step="0.1" style="width: 80px;"></td></tr>
                        <tr><td>IPA (Isopropyl Alcohol)</td><td><input type="number" id="priceIPA" value="0.12" step="0.01" style="width: 80px;"></td><td><input type="number" id="amountIPA" value="3.0" step="0.1" style="width: 80px;"></td></tr>
                        <tr><td>Acetone</td><td><input type="number" id="priceAcetone" value="0.10" step="0.01" style="width: 80px;"></td><td><input type="number" id="amountAcetone" value="3.0" step="0.1" style="width: 80px;"></td></tr>
                        <tr><td>MEK (Methyl Ethyl Ketone)</td><td><input type="number" id="priceMEK" value="0.20" step="0.01" style="width: 80px;"></td><td><input type="number" id="amountMEK" value="4.0" step="0.1" style="width: 80px;"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card">
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="calculate()" id="calculateBtn">CALCULATE</button>
                <button type="button" class="btn btn-success" onclick="printReport()" id="printBtn" style="display:none;">Print/Export PDF</button>
                <button type="button" class="btn btn-success" onclick="saveCalculation()" id="saveBtn" style="display:none;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                <button type="button" class="btn btn-secondary" onclick="resetAll()">Reset</button>
            </div>
        </div>

        <!-- Results -->
        <div class="card results-section" id="resultsSection" style="display: none;">
            <h2>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h2>
            
            <!-- Main KPIs -->
            <div class="kpi-grid">
                <div class="kpi-item">
                    <span class="kpi-value" id="partsPerJig">0</span>
                    <div class="kpi-label">Parts per Jig</div>
                </div>
                <div class="kpi-item">
                    <span class="kpi-value" id="paintPerPart">0</span>
                    <div class="kpi-label">Paint per Part (g)</div>
                </div>
                <div class="kpi-item">
                    <span class="kpi-value" id="ctPerJig">0</span>
                    <div class="kpi-label">CT per Jig (s)</div>
                </div>
                <div class="kpi-item">
                    <span class="kpi-value" id="ctPerPart">0</span>
                    <div class="kpi-label">CT per Part (s)</div>
                </div>
                <div class="kpi-item">
                    <span class="kpi-value" id="costPerPart">0</span>
                    <div class="kpi-label">Total Cost per Part</div>
                </div>
            </div>

            <div class="orientation-tag" id="orientationTag"></div>

            <!-- Paint per Jig by Process -->
            <div class="process-breakdown">
                <h3 style="color: #10b981; margin: 20px 0 10px 0;">üé® Paint per Jig by Process</h3>
                <div class="kpi-grid" id="paintProcessBreakdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <!-- CT per Jig by Process -->
            <div class="process-breakdown">
                <h3 style="color: #10b981; margin: 20px 0 10px 0;">‚è±Ô∏è CT per Jig by Process</h3>
                <div class="kpi-grid" id="ctProcessBreakdown">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>

            <h3 style="color: #4fd1c7; margin: 20px 0 10px 0;">Cost Breakdown</h3>
            <div class="breakdown" id="costBreakdown"></div>

            <!-- Canvas Layout (‡πÅ‡∏ó‡∏ô ASCII) -->
            <h3 style="color: #4fd1c7; margin: 20px 0 10px 0;">üìê Jig Layout Visualization</h3>
            <div class="canvas-layout-container">
                <canvas id="layoutCanvas" width="700" height="400"></canvas>
                <div class="canvas-info" id="canvasInfo">
                    ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "CALCULATE" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Layout
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            ¬© 2025 bunnamchai.bu2025 - ‡∏™‡∏á‡∏ß‡∏ô‡∏•‡∏¥‡∏Ç‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
        </div>
    </div>

    <!-- Info Collection Modal -->
    <div id="infoCollectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h2>
                <button type="button" class="close-btn" onclick="closeInfoModal()">&times;</button>
            </div>
            <form id="infoCollectionForm" onsubmit="handleInfoSubmit(event)">
                <div class="form-group">
                    <label for="customerName">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="customerName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Toyota Motor Thailand">
                </div>
                <div class="form-group">
                    <label for="modelName">‡∏ä‡∏∑‡πà‡∏≠ Model <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="modelName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Camry 2024">
                </div>
                <div class="form-group">
                    <label for="partName">‡∏ä‡∏∑‡πà‡∏≠ Part <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="partName" required placeholder="‡πÄ‡∏ä‡πà‡∏ô Front Bumper">
                </div>
                <div class="form-group">
                    <label for="partNumber">Part Number <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="partNumber" required placeholder="‡πÄ‡∏ä‡πà‡∏ô FB-001-2024">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeInfoModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button type="submit" class="btn btn-success" id="infoSubmitBtn">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Section (Hidden) -->
    <div class="print-section" id="printSection">
        <!-- Print content will be generated here -->
    </div>

    <script>
        // Global variables
        let layers = [];
        let paintDB = [];
        let calculationResults = null;
        let selectedPreset = null;
        let pendingAction = null;
        let projectInfo = {};
        window.PLASTICS = {};
        window.CT_PRESET = {};

        // Canvas variables
        const canvas = document.getElementById('layoutCanvas');
        const ctx = canvas.getContext('2d');
        let layoutResult = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkUserLogin();
            loadExternalData();
            setupImagePreview();
            initializeDB();
            setupCleaningCalculation();
            setupPresetSelection();
            setupJigCalculationMode();
            setupCTCalculation();
            setupCanvasEventListeners();
            setupCleaningProcesses();
        });

        // User authentication check
        function checkUserLogin() {
            const user = JSON.parse(localStorage.getItem('currentUser') || '{"username":"guest","role":"user"}');
            document.getElementById('userInfo').textContent = `‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${user.username} (${user.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'})`;
        }

        // Setup cleaning processes dropdowns
        function setupCleaningProcesses() {
            const cleaningProcesses = ['cleanBeforeBase', 'cleanBeforeTopcoat', 'cleanBeforeTF'];
            
            cleaningProcesses.forEach(processId => {
                const checkbox = document.getElementById(processId);
                const dropdown = document.getElementById(processId + 'Agent');
                
                checkbox.addEventListener('change', function() {
                    dropdown.style.display = this.checked ? 'inline-block' : 'none';
                });
            });
        }

        // Calculate cleaning costs with new system
        function calculateCleaningCosts(totalPaintPerPart) {
            let cleaningCost = 0;
            const cleaningData = [];
            
            const cleaningAgents = {
                'p700': { price: parseFloat(document.getElementById('priceP700').value) || 0.18, defaultAmount: parseFloat(document.getElementById('amountP700').value) || 5.0 },
                'pm': { price: parseFloat(document.getElementById('pricePM').value) || 0.15, defaultAmount: parseFloat(document.getElementById('amountPM').value) || 5.0 },
                'ipa': { price: parseFloat(document.getElementById('priceIPA').value) || 0.12, defaultAmount: parseFloat(document.getElementById('amountIPA').value) || 3.0 },
                'acetone': { price: parseFloat(document.getElementById('priceAcetone').value) || 0.10, defaultAmount: parseFloat(document.getElementById('amountAcetone').value) || 3.0 },
                'mek': { price: parseFloat(document.getElementById('priceMEK').value) || 0.20, defaultAmount: parseFloat(document.getElementById('amountMEK').value) || 4.0 }
            };
            
            // ‡πÄ‡∏ä‡πá‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (20% ‡∏Ç‡∏≠‡∏á‡∏™‡∏µ)
            if (document.getElementById('cleanNewWork').checked) {
                const agentType = document.getElementById('cleanNewWorkAgent').value;
                const agent = cleaningAgents[agentType];
                const amount = totalPaintPerPart * 0.2; // 20% ‡∏Ç‡∏≠‡∏á‡∏™‡∏µ
                const cost = amount * agent.price;
                
                cleaningCost += cost;
                cleaningData.push({
                    name: `‡πÄ‡∏ä‡πá‡∏î‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (${agentType.toUpperCase()})`,
                    mass: amount,
                    cost: cost,
                    process: 'initial'
                });
            }
            
            // ‡πÄ‡∏ä‡πá‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞ process
            const processes = [
                { id: 'cleanBeforeBase', name: '‡πÄ‡∏ä‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô Base' },
                { id: 'cleanBeforeTopcoat', name: '‡πÄ‡∏ä‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô Topcoat' },
                { id: 'cleanBeforeTF', name: '‡πÄ‡∏ä‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô T/F' }
            ];
            
            processes.forEach(proc => {
                const checkbox = document.getElementById(proc.id);
                if (checkbox.checked) {
                    const agentType = document.getElementById(proc.id + 'Agent').value;
                    const agent = cleaningAgents[agentType];
                    const amount = agent.defaultAmount; // ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì default
                    const cost = amount * agent.price;
                    
                    cleaningCost += cost;
                    cleaningData.push({
                        name: `${proc.name} (${agentType.toUpperCase()})`,
                        mass: amount,
                        cost: cost,
                        process: proc.id
                    });
                }
            });
            
            return { cleaningCost, cleaningData };
        }

        // Setup canvas event listeners
        function setupCanvasEventListeners() {
            ['partWidth', 'partHeight', 'jigWidth', 'jigHeight', 'minGap'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    if (calculationResults) {
                        updateCanvasLayout();
                    }
                });
            });
            
            ['tryRotate', 'allowClipping'].forEach(id => {
                document.getElementById(id).addEventListener('change', () => {
                    if (calculationResults) {
                        updateCanvasLayout();
                    }
                });
            });
        }

        // Setup CT calculation
        function setupCTCalculation() {
            document.getElementById('autoCalcCT').addEventListener('change', function() {
                if (this.checked) {
                    updateTotalCT();
                }
            });

            // Event listeners for CT inputs
            ['ctCleanInput', 'ctBaseInput', 'ctTopcoatInput', 'ctInspectInput'].forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (document.getElementById('autoCalcCT').checked) {
                        updateTotalCT();
                    }
                });
            });
        }

        function updateTotalCT() {
            const ctClean = parseFloat(document.getElementById('ctCleanInput').value) || 0;
            const ctBase = parseFloat(document.getElementById('ctBaseInput').value) || 0;
            const ctTopcoat = parseFloat(document.getElementById('ctTopcoatInput').value) || 0;
            const ctInspect = parseFloat(document.getElementById('ctInspectInput').value) || 0;
            
            const totalCT = ctClean + ctBase + ctTopcoat + ctInspect;
            document.getElementById('cycleTime').value = totalCT;
        }

        // Setup preset selection
        function setupPresetSelection() {
            const usePreset = document.getElementById('usePreset');
            const presetOptions = document.getElementById('presetOptions');
            const presetItems = document.querySelectorAll('.preset-item');
            
            usePreset.addEventListener('change', function() {
                presetOptions.style.display = this.checked ? 'block' : 'none';
                if (!this.checked) {
                    selectedPreset = null;
                    document.getElementById('selectedPreset').style.display = 'none';
                    presetItems.forEach(item => item.classList.remove('selected'));
                }
            });
            
            presetItems.forEach(item => {
                item.addEventListener('click', function() {
                    presetItems.forEach(i => i.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedPreset = this.dataset.preset;
                    document.getElementById('selectedPreset').style.display = 'block';
                    document.getElementById('selectedPresetName').textContent = this.querySelector('h3').textContent;
                    applyPresetSettings(selectedPreset);
                });
            });
        }

        function applyPresetSettings(preset) {
            switch(preset) {
                case 'paint-only':
                    document.getElementById('ctCleanInput').value = 15;
                    document.getElementById('ctBaseInput').value = 80;
                    document.getElementById('ctTopcoatInput').value = 0;
                    document.getElementById('ctInspectInput').value = 15;
                    layers = [];
                    layers.push({ paintId: 'preset-base', thickness: 20, readyToUsePrice: 0.5 });
                    break;
                case 'decoration':
                    document.getElementById('ctCleanInput').value = 15;
                    document.getElementById('ctBaseInput').value = 60;
                    document.getElementById('ctTopcoatInput').value = 45;
                    document.getElementById('ctInspectInput').value = 20;
                    layers = [];
                    layers.push({ paintId: 'preset-base', thickness: 20, readyToUsePrice: 0.5 });
                    layers.push({ paintId: 'preset-top', thickness: 20, readyToUsePrice: 0.72 });
                    break;
                case 'decoration-2':
                    document.getElementById('ctCleanInput').value = 15;
                    document.getElementById('ctBaseInput').value = 0;
                    document.getElementById('ctTopcoatInput').value = 45;
                    document.getElementById('ctInspectInput').value = 20;
                    layers = [];
                    layers.push({ paintId: 'preset-top', thickness: 20, readyToUsePrice: 0.72 });
                    break;
                case 'topcoat-only':
                    document.getElementById('ctCleanInput').value = 15;
                    document.getElementById('ctBaseInput').value = 0;
                    document.getElementById('ctTopcoatInput').value = 60;
                    document.getElementById('ctInspectInput').value = 15;
                    layers = [];
                    layers.push({ paintId: 'preset-top', thickness: 20, readyToUsePrice: 0.72 });
                    break;
            }
            
            if (document.getElementById('autoCalcCT').checked) {
                updateTotalCT();
            }
            updateLayersTable();
        }

        // Setup jig calculation mode
        function setupJigCalculationMode() {
            const autoCalc = document.getElementById('autoCalculate');
            const manualInput = document.getElementById('manualInput');
            const manualGroup = document.getElementById('manualPartsGroup');
            
            autoCalc.addEventListener('change', function() {
                if (this.checked) {
                    manualGroup.style.display = 'none';
                }
            });
            
            manualInput.addEventListener('change', function() {
                if (this.checked) {
                    manualGroup.style.display = 'block';
                }
            });
        }

        // Cleaning materials calculation setup
        function setupCleaningCalculation() {
            // Using new system with dropdowns
        }

        // Image preview setup
        function setupImagePreview() {
            const imageInput = document.getElementById('partImage');
            const preview = document.getElementById('imagePreview');
            
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });
        }

        // Database functions
        function initializeDB() {
            const stored = localStorage.getItem('paintDB_v1');
            if (stored) {
                paintDB = JSON.parse(stored);
            }
            updateLayerPaintOptions();
        }

        function getDB() {
            return paintDB;
        }

        function setDB(data) {
            paintDB = data;
            localStorage.setItem('paintDB_v1', JSON.stringify(paintDB));
            updateLayerPaintOptions();
        }

        // Layer functions
        function addLayer() {
            const layer = {
                paintId: '',
                thickness: 20,
                readyToUsePrice: 0.5
            };
            layers.push(layer);
            updateLayersTable();
        }

        function removeLastLayer() {
            if (layers.length > 0) {
                layers.pop();
                updateLayersTable();
            }
        }

        function presetDecoration() {
            layers = [];
            layers.push({ paintId: 'preset-base', thickness: 20, readyToUsePrice: 0.5 });
            layers.push({ paintId: 'preset-top', thickness: 20, readyToUsePrice: 0.72 });
            updateLayersTable();
        }

        function updateLayersTable() {
            const tbody = document.getElementById('layersTable');
            tbody.innerHTML = '';

            layers.forEach((layer, index) => {
                const row = tbody.insertRow();
                
                row.innerHTML = `
                    <td>
                        <select onchange="updateLayerPaint(${index}, this.value)">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ</option>
                            <option value="preset-base" ${layer.paintId === 'preset-base' ? 'selected' : ''}>Base Color (Preset)</option>
                            <option value="preset-top" ${layer.paintId === 'preset-top' ? 'selected' : ''}>Top Coat (Preset)</option>
                            <option value="preset-primer" ${layer.paintId === 'preset-primer' ? 'selected' : ''}>Primer (Preset)</option>
                            ${paintDB.map(paint => 
                                `<option value="${paint.id}" ${layer.paintId === paint.id ? 'selected' : ''}>${paint.name}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>${getLayerType(layer.paintId)}</td>
                    <td>
                        <input type="number" value="${layer.readyToUsePrice || 0.5}" step="0.01" min="0"
                               onchange="updateLayerPrice(${index}, this.value)">
                    </td>
                    <td>
                        <input type="number" value="${layer.thickness}" min="1" max="100" 
                               onchange="updateLayerThickness(${index}, this.value)">
                    </td>
                `;
            });
        }

        function getLayerType(paintId) {
            if (paintId.includes('primer')) return 'Primer';
            if (paintId.includes('base')) return 'Base';
            if (paintId.includes('top')) return 'Top';
            
            const paint = paintDB.find(p => p.id === paintId);
            return paint ? paint.type : '-';
        }

        function updateLayerPaint(index, paintId) {
            layers[index].paintId = paintId;
            const paint = paintDB.find(p => p.id === paintId);
            if (paint && paint.ready_to_use_price) {
                layers[index].readyToUsePrice = paint.ready_to_use_price;
            }
            updateLayersTable();
        }

        function updateLayerThickness(index, thickness) {
            layers[index].thickness = parseFloat(thickness) || 20;
        }

        function updateLayerPrice(index, price) {
            layers[index].readyToUsePrice = parseFloat(price) || 0.5;
        }

        function updateLayerPaintOptions() {
            setTimeout(() => {
                updateLayersTable();
            }, 100);
        }

        // Ensure Primer for PP plastic
        function ensurePrimerForPP() {
            const plasticType = document.getElementById('plasticType').value;
            if (plasticType !== 'PP') return;

            const hasPrimer = layers.some(layer => {
                return getLayerType(layer.paintId) === 'Primer';
            });

            if (!hasPrimer) {
                layers.unshift({
                    paintId: 'preset-primer',
                    thickness: 10,
                    readyToUsePrice: 0.42
                });
                updateLayersTable();
            }
        }

        // Calculation functions
        function surfaceAreaRect(w, h, d, factor) {
            return 2 * (w * h + w * d + h * d) * factor;
        }

        function partsPerJig(partW, partH, jigW, jigH, gap, tryRotate, allowClipping) {
            const availW = jigW - 2 * gap;
            const availH = jigH - 2 * gap;
            
            function calculateLayout(pW, pH) {
                if (pW + gap > availW + gap) return { count: 0, cols: 0, rows: 0 };
                
                const cols = Math.floor((availW + gap) / (pW + gap));
                
                let maxHeight = availH;
                if (allowClipping && jigH === 50) {
                    maxHeight = availH * 1.2;
                }
                
                let rows = 0;
                if (pH <= maxHeight + gap) {
                    rows = Math.floor((maxHeight + gap) / (pH + gap));
                }
                
                return { count: cols * rows, cols, rows };
            }

            const layoutA = calculateLayout(partW, partH);
            let selectedLayout = { ...layoutA, rotated: false };

            if (tryRotate && partW !== partH) {
                const layoutB = calculateLayout(partH, partW);
                if (layoutB.count > layoutA.count) {
                    selectedLayout = { ...layoutB, rotated: true };
                }
            }

            return selectedLayout;
        }

        // Canvas drawing functions
        function drawJigLayout(jigW, jigH, partW, partH, gap, layout) {
            const padding = 40;
            const canvasW = canvas.width - 2 * padding;
            const canvasH = canvas.height - 2 * padding;
            
            const scaleW = canvasW / jigW;
            const scaleH = canvasH / jigH;
            const scale = Math.min(scaleW, scaleH) * 0.9;
            
            const jigDrawW = jigW * scale;
            const jigDrawH = jigH * scale;
            const startX = (canvas.width - jigDrawW) / 2;
            const startY = (canvas.height - jigDrawH) / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawGrid(scale);
            
            // Draw Jig boundary
            ctx.strokeStyle = '#0066ff';
            ctx.lineWidth = 3;
            ctx.fillStyle = 'rgba(0, 102, 255, 0.1)';
            ctx.fillRect(startX, startY, jigDrawW, jigDrawH);
            ctx.strokeRect(startX, startY, jigDrawW, jigDrawH);
            
            ctx.fillStyle = '#0066ff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Jig: ${jigW}√ó${jigH}cm`, startX + jigDrawW/2, startY - 10);
            
            if (layout.count === 0) {
                ctx.fillStyle = '#ff6b6b';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ', startX + jigDrawW/2, startY + jigDrawH/2);
                return;
            }
            
            const actualPartW = layout.rotated ? partH : partW;
            const actualPartH = layout.rotated ? partW : partH;
            
            ctx.fillStyle = 'rgba(51, 204, 119, 0.7)';
            ctx.strokeStyle = '#33cc77';
            ctx.lineWidth = 2;
            
            for (let i = 0; i < layout.count; i++) {
                const col = i % layout.cols;
                const row = Math.floor(i / layout.cols);
                
                const partX = startX + gap * scale + col * (actualPartW + gap) * scale;
                const partY = startY + gap * scale + row * (actualPartH + gap) * scale;
                const partDrawW = actualPartW * scale;
                const partDrawH = actualPartH * scale;
                
                ctx.fillRect(partX, partY, partDrawW, partDrawH);
                ctx.strokeRect(partX, partY, partDrawW, partDrawH);
                
                ctx.fillStyle = '#000';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText((i + 1).toString(), 
                    partX + partDrawW/2, 
                    partY + partDrawH/2 + 4);
                
                if (scale > 3) {
                    ctx.font = '10px Arial';
                    ctx.fillText(`${actualPartW}√ó${actualPartH}`, 
                        partX + partDrawW/2, 
                        partY + partDrawH/2 + 16);
                }
                
                ctx.fillStyle = 'rgba(51, 204, 119, 0.7)';
            }
            
            drawScaleReference(startX, startY + jigDrawH + 30, scale);
            
            if (layout.rotated) {
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('üîÑ Rotated 90¬∞ for optimal layout', startX, startY + jigDrawH + 60);
            }
        }

        function drawGrid(scale) {
            const gridSize = 5 * scale;
            if (gridSize < 20) return;
            
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;
            
            for (let x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        function drawScaleReference(x, y, scale) {
            const refLength = 10 * scale;
            if (refLength < 30) return;
            
            ctx.strokeStyle = '#4fd1c7';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x + refLength, y);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(x, y - 5);
            ctx.lineTo(x, y + 5);
            ctx.moveTo(x + refLength, y - 5);
            ctx.lineTo(x + refLength, y + 5);
            ctx.stroke();
            
            ctx.fillStyle = '#4fd1c7';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('10cm', x + refLength/2, y + 20);
        }

        function updateCanvasLayout() {
            if (!calculationResults) return;
            
            const partW = parseFloat(document.getElementById('partWidth').value) || 0;
            const partH = parseFloat(document.getElementById('partHeight').value) || 0;
            const jigW = parseFloat(document.getElementById('jigWidth').value) || 50;
            const jigH = parseFloat(document.getElementById('jigHeight').value) || 60;
            const gap = parseFloat(document.getElementById('minGap').value) || 2;
            const tryRotate = document.getElementById('tryRotate').checked;
            const allowClipping = document.getElementById('allowClipping').checked;
            
            layoutResult = partsPerJig(partW, partH, jigW, jigH, gap, tryRotate, allowClipping);
            updateCanvasInfo(layoutResult, jigW, jigH, partW, partH, allowClipping);
            drawJigLayout(jigW, jigH, partW, partH, gap, layoutResult);
        }

        function updateCanvasInfo(layout, jigW, jigH, partW, partH, allowClipping) {
            const infoEl = document.getElementById('canvasInfo');
            
            if (layout.count === 0) {
                infoEl.innerHTML = `
                    <div style="color: #fbbf24;">
                        ‚ùå <strong>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ</strong><br>
                        ‡∏ä‡∏¥‡πâ‡∏ô‡∏á‡∏≤‡∏ô ${partW}√ó${partH}cm ‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Jig ${jigW}√ó${jigH}cm
                    </div>
                `;
            } else {
                const efficiency = ((layout.count * partW * partH) / (jigW * jigH) * 100).toFixed(1);
                infoEl.innerHTML = `
                    <div style="color: #10b981;">
                        ‚úÖ <strong>‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á: ${layout.count} ‡∏ä‡∏¥‡πâ‡∏ô</strong> | 
                        ${layout.cols} ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå √ó ${layout.rows} ‡πÅ‡∏ñ‡∏ß | 
                        ‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û: ${efficiency}%
                        ${layout.rotated ? ' | üîÑ ‡∏´‡∏°‡∏∏‡∏ô 90¬∞' : ''}
                    </div>
                `;
            }
        }

        // Process breakdown display functions
        function updateProcessBreakdowns(calculationResults, layout) {
            // Paint Process Breakdown
            const paintContainer = document.getElementById('paintProcessBreakdown');
            if (calculationResults.paintByProcess) {
                let paintHTML = '';
                Object.entries(calculationResults.paintByProcess).forEach(([process, data]) => {
                    if (data.mass > 0) {
                        const paintPerJig = data.mass * layout.count;
                        paintHTML += `
                            <div class="kpi-item">
                                <span class="kpi-value">${paintPerJig.toFixed(1)}g</span>
                                <div class="kpi-label">Paint ${process.toUpperCase()} per Jig</div>
                            </div>
                        `;
                    }
                });
                paintContainer.innerHTML = paintHTML || '<p style="text-align: center; color: #b0b8c4;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Paint ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Process</p>';
            }
            
            // CT Process Breakdown
            const ctContainer = document.getElementById('ctProcessBreakdown');
            if (calculationResults.ctByProcess) {
                let ctHTML = '';
                Object.entries(calculationResults.ctByProcess).forEach(([process, time]) => {
                    if (time > 0) {
                        let displayName = process;
                        switch(process) {
                            case 'cleanBeforeBase': displayName = 'CT ‡πÄ‡∏ä‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô BASE'; break;
                            case 'base': displayName = 'CT BASE'; break;
                            case 'cleanBeforeTopcoat': displayName = 'CT ‡πÄ‡∏ä‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô TOPCOAT'; break;
                            case 'topcoat': displayName = 'CT TOPCOAT'; break;
                            case 'inspect': displayName = 'CT ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö'; break;
                        }
                        ctHTML += `
                            <div class="kpi-item">
                                <span class="kpi-value">${time}s</span>
                                <div class="kpi-label">${displayName}</div>
                            </div>
                        `;
                    }
                });
                ctContainer.innerHTML = ctHTML || '<p style="text-align: center; color: #b0b8c4;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• CT ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Process</p>';
            }
        }

        // Main calculation function
        function calculate() {
            ensurePrimerForPP();
            
            const partW = parseFloat(document.getElementById('partWidth').value) || 0;
            const partH = parseFloat(document.getElementById('partHeight').value) || 0;
            const partD = parseFloat(document.getElementById('partDepth').value) || 0;
            const surfaceFactor = parseFloat(document.getElementById('surfaceFactor').value) || 10;
            const lossPct = parseFloat(document.getElementById('lossPct').value) || 0;
            const jigW = parseFloat(document.getElementById('jigWidth').value) || 50;
            const jigH = parseFloat(document.getElementById('jigHeight').value) || 60;
            const gap = parseFloat(document.getElementById('minGap').value) || 2;
            const tryRotate = document.getElementById('tryRotate').checked;
            const allowClipping = document.getElementById('allowClipping').checked;
            const cycleTime = parseFloat(document.getElementById('cycleTime').value) || 120;
            const currency = document.getElementById('currency').value || '‡∏ø';

            const surfaceArea = surfaceAreaRect(partW, partH, partD, surfaceFactor);
            
            let layout;
            const isManual = document.getElementById('manualInput').checked;
            
            if (isManual) {
                const manualParts = parseInt(document.getElementById('manualPartsPerJig').value) || 1;
                layout = { count: manualParts, cols: 0, rows: 0, rotated: false };
            } else {
                layout = partsPerJig(partW, partH, jigW, jigH, gap, tryRotate, allowClipping);
            }
            
            layoutResult = layout;
            
            // Paint by Process calculation
            let paintByProcess = {
                primer: { mass: 0, cost: 0 },
                base: { mass: 0, cost: 0 },
                topcoat: { mass: 0, cost: 0 }
            };

            let totalPaintPerPart = 0;
            let costBreakdownData = [];
            let totalCostPerPart = 0;
            
            layers.forEach(layer => {
                if (layer.thickness > 0 && layer.readyToUsePrice > 0) {
                    const volumeCm3 = surfaceArea * (layer.thickness * 1e-4);
                    const massGrams = volumeCm3 * 1.2;
                    const massWithLoss = massGrams * (1 + lossPct / 100);
                    
                    let processType = 'base';
                    if (layer.paintId.includes('primer')) processType = 'primer';
                    else if (layer.paintId.includes('base')) processType = 'base';
                    else if (layer.paintId.includes('top')) processType = 'topcoat';
                    
                    paintByProcess[processType].mass += massWithLoss;
                    paintByProcess[processType].cost += massWithLoss * layer.readyToUsePrice;
                    
                    totalPaintPerPart += massWithLoss;
                    
                    const layerCost = massWithLoss * layer.readyToUsePrice;
                    totalCostPerPart += layerCost;
                    
                    const paintName = layer.paintId.startsWith('preset-') ? 
                        layer.paintId.replace('preset-', '').toUpperCase() : 
                        (paintDB.find(p => p.id === layer.paintId)?.name || 'Unknown');
                    
                    costBreakdownData.push({
                        name: `${paintName} (${processType.toUpperCase()})`,
                        mass: massWithLoss,
                        cost: layerCost,
                        process: processType
                    });
                }
            });

            // Calculate cleaning costs
            const { cleaningCost, cleaningData } = calculateCleaningCosts(totalPaintPerPart);
            totalCostPerPart += cleaningCost;
            costBreakdownData.push(...cleaningData);
            
            const paintPerJig = totalPaintPerPart * layout.count;
            const ctPerPart = layout.count > 0 ? cycleTime / layout.count : 0;
            
            // CT by Process breakdown
            const ctByProcess = {
                cleanBeforeBase: parseFloat(document.getElementById('ctCleanInput').value) || 0,
                base: parseFloat(document.getElementById('ctBaseInput').value) || 0,
                cleanBeforeTopcoat: Math.round((parseFloat(document.getElementById('ctCleanInput').value) || 0) * 0.5),
                topcoat: parseFloat(document.getElementById('ctTopcoatInput').value) || 0,
                inspect: parseFloat(document.getElementById('ctInspectInput').value) || 0
            };
            
            const ctBreakdown = {
                clean: parseFloat(document.getElementById('ctCleanInput').value) || 0,
                base: parseFloat(document.getElementById('ctBaseInput').value) || 0,
                topcoat: parseFloat(document.getElementById('ctTopcoatInput').value) || 0,
                inspect: parseFloat(document.getElementById('ctInspectInput').value) || 0
            };
            
            calculationResults = {
                partW, partH, partD, surfaceFactor, lossPct, jigW, jigH, gap, tryRotate, allowClipping, cycleTime,
                surfaceArea, layout, totalPaintPerPart, paintPerJig, ctPerPart, totalCostPerPart,
                costBreakdownData, currency, selectedPreset, ctBreakdown, ctByProcess, paintByProcess,
                calculationDate: new Date().toLocaleDateString('th-TH'),
                isManualJig: isManual,
                layers: [...layers]
            };
            
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('resultsSection').classList.add('animate-in');
            document.getElementById('printBtn').style.display = 'inline-block';
            document.getElementById('save            Btn').style.display = 'inline-block';
            
            animateCounter('partsPerJig', 0, layout.count, 0);
            animateCounter('paintPerPart', 0, totalPaintPerPart, 2);
            animateCounter('ctPerJig', 0, cycleTime, 0);
            animateCounter('ctPerPart', 0, ctPerPart, 1);
            animateCounter('costPerPart', 0, totalCostPerPart, 2, currency);
            
            document.getElementById('orientationTag').textContent = 
                isManual ? 'Manual Input' : (layout.rotated ? 'Rotated 90¬∞' : 'Default Orientation');
            
            updateCostBreakdown(costBreakdownData, totalCostPerPart, currency);
            updateProcessBreakdowns(calculationResults, layout);
            
            // Draw Canvas Layout ‡∏û‡∏£‡πâ‡∏≠‡∏° Seams ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            setTimeout(() => {
                drawJigLayoutWithSeams(jigW, jigH, partW, partH, gap, layout);
                updateCanvasInfo(layout, jigW, jigH, partW, partH, allowClipping);
            }, 500);
        }

        // ======== ENHANCED CANVAS DRAWING WITH SEAMS ========
        function drawPartWithSeams(x, y, w, h, ctx, partNumber) {
            // Fill part with green color
            ctx.fillStyle = 'rgba(51, 204, 119, 0.7)';
            ctx.fillRect(x, y, w, h);
            
            // Draw thick border with bright green
            ctx.strokeStyle = '#00ff00'; // bright green
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, w, h);
            
            // Draw corner joint circles (seam indicators)
            const radius = 4;
            const corners = [
                [x, y],           // top-left
                [x + w, y],       // top-right
                [x, y + h],       // bottom-left
                [x + w, y + h]    // bottom-right
            ];
            
            corners.forEach(([cx, cy]) => {
                ctx.beginPath();
                ctx.fillStyle = '#ffff00';  // yellow joints
                ctx.strokeStyle = '#cc9900';
                ctx.lineWidth = 1.5;
                ctx.arc(cx, cy, radius, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
            });
            
            // Draw part number in center
            ctx.fillStyle = '#000';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(partNumber.toString(), x + w/2, y + h/2 + 4);
            
            // Draw dimensions if scale is large enough
            const scale = w / 10; // approximate scale
            if (scale > 3) {
                ctx.font = '10px Arial';
                const actualW = layout.rotated ? partH : partW;
                const actualH = layout.rotated ? partW : partH;
                ctx.fillText(`${actualW}√ó${actualH}cm`, x + w/2, y + h/2 + 16);
            }
        }

        // Enhanced Jig Layout Drawing
        function drawJigLayoutWithSeams(jigW, jigH, partW, partH, gap, layout) {
            const padding = 40;
            const canvasW = canvas.width - 2 * padding;
            const canvasH = canvas.height - 2 * padding;
            
            const scaleW = canvasW / jigW;
            const scaleH = canvasH / jigH;
            const scale = Math.min(scaleW, scaleH) * 0.9;
            
            const jigDrawW = jigW * scale;
            const jigDrawH = jigH * scale;
            const startX = (canvas.width - jigDrawW) / 2;
            const startY = (canvas.height - jigDrawH) / 2;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            drawGrid(scale);
            
            // Draw Jig boundary with blue color
            ctx.strokeStyle = '#0066ff';
            ctx.lineWidth = 3;
            ctx.fillStyle = 'rgba(0, 102, 255, 0.1)';
            ctx.fillRect(startX, startY, jigDrawW, jigDrawH);
            ctx.strokeRect(startX, startY, jigDrawW, jigDrawH);
            
            // Jig label
            ctx.fillStyle = '#0066ff';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(`Jig: ${jigW}√ó${jigH}cm`, startX + jigDrawW/2, startY - 10);
            
            if (layout.count === 0) {
                ctx.fillStyle = '#ff6b6b';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ', startX + jigDrawW/2, startY + jigDrawH/2);
                return;
            }
            
            const actualPartW = layout.rotated ? partH : partW;
            const actualPartH = layout.rotated ? partW : partH;
            
            // Draw each part with seams
            for (let i = 0; i < layout.count; i++) {
                const col = i % layout.cols;
                const row = Math.floor(i / layout.cols);
                
                const partX = startX + gap * scale + col * (actualPartW + gap) * scale;
                const partY = startY + gap * scale + row * (actualPartH + gap) * scale;
                const partDrawW = actualPartW * scale;
                const partDrawH = actualPartH * scale;
                
                // *** USE ENHANCED DRAWING WITH SEAMS ***
                drawPartWithSeams(partX, partY, partDrawW, partDrawH, ctx, i + 1);
            }
            
            drawScaleReference(startX, startY + jigDrawH + 30, scale);
            
            if (layout.rotated) {
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'left';
                ctx.fillText('üîÑ Rotated 90¬∞ for optimal layout', startX, startY + jigDrawH + 60);
            }
        }

        // Modal functions for Print/Save
        function printReport() {
            if (!calculationResults) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå');
                return;
            }
            
            pendingAction = 'print';
            openInfoModal();
        }

        function saveCalculation() {
            if (!calculationResults) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                return;
            }
            
            pendingAction = 'save';
            openInfoModal();
        }

        function openInfoModal() {
            document.getElementById('infoCollectionModal').style.display = 'flex';
        }

        function closeInfoModal() {
            document.getElementById('infoCollectionModal').style.display = 'none';
            document.getElementById('infoCollectionForm').reset();
            pendingAction = null;
        }

        function handleInfoSubmit(event) {
            event.preventDefault();
            
            projectInfo = {
                customer: document.getElementById('customerName').value.trim(),
                modelName: document.getElementById('modelName').value.trim(),
                partName: document.getElementById('partName').value.trim(),
                partNumber: document.getElementById('partNumber').value.trim()
            };
            
            closeInfoModal();
            
            if (pendingAction === 'print') {
                executeActualPrint();
            } else if (pendingAction === 'save') {
                executeActualSave();
            }
        }

        function executeActualPrint() {
            generateAndPrintReport();
        }

        function executeActualSave() {
            const savedCalculations = JSON.parse(localStorage.getItem('savedCalculations') || '[]');
            
            const newCalculation = {
                id: Date.now(),
                ...projectInfo,
                ...calculationResults,
                saveDate: new Date().toISOString(),
                layers: [...layers],
                cleaningProcesses: {
                    cleanNewWork: document.getElementById('cleanNewWork').checked,
                    cleanBeforeBase: document.getElementById('cleanBeforeBase').checked,
                    cleanBeforeTopcoat: document.getElementById('cleanBeforeTopcoat').checked,
                    cleanBeforeTF: document.getElementById('cleanBeforeTF').checked
                }
            };
            
            savedCalculations.push(newCalculation);
            localStorage.setItem('savedCalculations', JSON.stringify(savedCalculations));
            
            alert(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${projectInfo.modelName} - ${projectInfo.partName}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
        }

        // Enhanced Print Function
        function generateAndPrintReport() {
            const printSection = document.getElementById('printSection');
            const currentDate = new Date().toLocaleDateString('th-TH');
            const currentTime = new Date().toLocaleTimeString('th-TH');
            
            const imageElement = document.getElementById('imagePreview');
            const hasImage = imageElement && imageElement.src && imageElement.style.display !== 'none';
            
            printSection.innerHTML = `
                <div class="print-container">
                    <!-- Header -->
                    <div class="print-header">
                        <div style="width: 60px;"></div>
                        <div class="print-company-info">
                            <h1>THAI CUBIC TECHNOLOGY CO. LTD.</h1>
                            <h2>PRE COST ANALYSIS NPD REPORT</h2>
                            <p><strong>Date:</strong> ${currentDate} ${currentTime}</p>
                        </div>
                        <div style="width: 60px;"></div>
                    </div>

                    <!-- Project Information -->
                    <div class="print-section-title">1. PROJECT INFORMATION</div>
                    <table class="print-table compact-section">
                        <tr><th>Customer</th><td>${projectInfo.customer}</td><th>Model</th><td>${projectInfo.modelName}</td></tr>
                        <tr><th>Part Name</th><td>${projectInfo.partName}</td><th>Part No.</th><td>${projectInfo.partNumber}</td></tr>
                        <tr><th>Material</th><td>${document.getElementById('plasticType').value}</td><th>Process</th><td>${calculationResults.selectedPreset || 'Custom'}</td></tr>
                    </table>

                    <!-- Part Specifications with Image -->
                    <div class="print-section-title">2. PART SPECIFICATIONS</div>
                    <div class="part-specifications">
                        <div class="part-specs-table">
                            <table class="print-table">
                                <tr><th>Dimension (W√óH√óD)</th><td>${calculationResults.partW} √ó ${calculationResults.partH} √ó ${calculationResults.partD} cm</td></tr>
                                <tr><th>Surface Area</th><td>${calculationResults.surfaceArea.toFixed(2)} cm¬≤</td></tr>
                                <tr><th>Surface Factor</th><td>${calculationResults.surfaceFactor}</td></tr>
                                <tr><th>Loss Percentage</th><td>${calculationResults.lossPct}%</td></tr>
                            </table>
                        </div>
                        <div class="part-image-container">
                            ${hasImage ? 
                                `<img src="${imageElement.src}" class="part-image" alt="Part Image">` : 
                                '<span style="font-size: 8px; color: #666;">No Image</span>'
                            }
                        </div>
                    </div>

                    <!-- Paint System by Process -->
                    <div class="print-section-title">3. PAINT SYSTEM BY PROCESS</div>
                    <table class="print-table compact-section">
                        <thead>
                            <tr><th>Process</th><th>Paint per Part (g)</th><th>Paint per Jig (g)</th><th>Cost per Part (‡∏ø)</th></tr>
                        </thead>
                        <tbody>
                            ${Object.entries(calculationResults.paintByProcess).map(([process, data]) => 
                                data.mass > 0 ? `<tr>
                                    <td>${process.toUpperCase()}</td>
                                    <td>${data.mass.toFixed(2)}</td>
                                    <td>${(data.mass * calculationResults.layout.count).toFixed(1)}</td>
                                    <td>${data.cost.toFixed(3)}</td>
                                </tr>` : ''
                            ).join('')}
                        </tbody>
                    </table>

                    <!-- CT Analysis by Process -->
                    <div class="print-section-title">4. CYCLE TIME ANALYSIS BY PROCESS</div>
                    <table class="print-table compact-section">
                        <thead>
                            <tr><th>Process</th><th>Time (sec)</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            ${Object.entries(calculationResults.ctByProcess).map(([process, time]) => 
                                time > 0 ? `<tr>
                                    <td>${process.replace(/([A-Z])/g, ' $1').trim()}</td>
                                    <td>${time}</td>
                                    <td>${process.includes('clean') ? 'Cleaning process' : 
                                         process.includes('base') ? 'Base coating' :
                                         process.includes('topcoat') ? 'Topcoat application' :
                                         process.includes('inspect') ? 'Quality inspection' : 'Process step'}</td>
                                </tr>` : ''
                            ).join('')}
                            <tr style="font-weight:bold;background-color:#f0f0f0;">
                                <td>Total CT per Jig</td><td>${calculationResults.cycleTime}</td><td>Complete production cycle</td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Layout & Cost Summary -->
                    <div class="print-section-title">5. JIG LAYOUT & COST SUMMARY</div>
                    <table class="print-table compact-section">
                        <tr><th>Jig Size</th><td>${calculationResults.jigW} √ó ${calculationResults.jigH} cm</td></tr>
                        <tr><th>Parts per Jig</th><td>${calculationResults.layout.count} pieces</td></tr>
                        <tr><th>Orientation</th><td>${calculationResults.layout.rotated ? 'Rotated 90¬∞' : 'Default Position'}</td></tr>
                        <tr><th>Production Rate</th><td>${(3600 / calculationResults.ctPerPart).toFixed(0)} pcs/hr</td></tr>
                    </table>

                    <div class="cost-summary">
                        <h2>FINAL COST: ${calculationResults.currency}${calculationResults.totalCostPerPart.toFixed(3)} PER PART</h2>
                    </div>
                </div>
            `;
            
            setTimeout(() => window.print(), 500);
        }

        // Animation functions
        function animateCounter(elementId, start, end, decimals = 0, prefix = '') {
            const element = document.getElementById(elementId);
            const duration = 1500;
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const currentValue = start + (end - start) * easeOut;
                
                element.textContent = prefix + currentValue.toFixed(decimals);
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                }
            }
            requestAnimationFrame(updateCounter);
        }

        function updateCostBreakdown(breakdownData, totalCost, currency) {
            const container = document.getElementById('costBreakdown');
            container.innerHTML = '';
            
            breakdownData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'breakdown-item';
                div.innerHTML = `
                    <span>${item.name} (${item.mass.toFixed(2)}g)</span>
                    <span>${currency}${item.cost.toFixed(2)}</span>
                `;
                container.appendChild(div);
            });
            
            const totalDiv = document.createElement('div');
            totalDiv.className = 'breakdown-item';
            totalDiv.innerHTML = `
                <span><strong>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</strong></span>
                <span><strong>${currency}${totalCost.toFixed(2)}</strong></span>
            `;
            container.appendChild(totalDiv);
        }

        // Data loading functions
        async function loadExternalData() {
            try {
                const paintsResponse = await fetch('paints.json', { cache: 'no-cache' });
                if (paintsResponse.ok) {
                    const paintsData = await paintsResponse.json();
                    setDB(paintsData);
                }
            } catch (error) {
                console.warn('Failed to load external data files:', error);
            }
        }

        function resetAll() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                // Reset form values
                document.getElementById('partWidth').value = '10';
                document.getElementById('partHeight').value = '5';
                document.getElementById('partDepth').value = '2';
                document.getElementById('surfaceFactor').value = '10';
                document.getElementById('lossPct').value = '30';
                document.getElementById('jigWidth').value = '50';
                document.getElementById('jigHeight').value = '60';
                document.getElementById('minGap').value = '2';
                document.getElementById('cycleTime').value = '120';
                
                // Reset CT inputs
                document.getElementById('ctCleanInput').value = '15';
                document.getElementById('ctBaseInput').value = '60';
                document.getElementById('ctTopcoatInput').value = '45';
                document.getElementById('ctInspectInput').value = '20';
                
                // Reset checkboxes
                document.getElementById('tryRotate').checked = false;
                document.getElementById('allowClipping').checked = false;
                document.getElementById('autoCalculate').checked = true;
                document.getElementById('autoCalcCT').checked = true;
                
                // Reset cleaning checkboxes
                document.getElementById('cleanNewWork').checked = true;
                document.getElementById('cleanBeforeBase').checked = false;
                document.getElementById('cleanBeforeTopcoat').checked = false;
                document.getElementById('cleanBeforeTF').checked = false;
                
                // Hide cleaning dropdowns
                document.getElementById('cleanBeforeBaseAgent').style.display = 'none';
                document.getElementById('cleanBeforeTopcoatAgent').style.display = 'none';
                document.getElementById('cleanBeforeTFAgent').style.display = 'none';
                
                // Reset other elements
                document.getElementById('manualPartsGroup').style.display = 'none';
                document.getElementById('plasticType').selectedIndex = 0;
                document.getElementById('usePreset').checked = false;
                document.getElementById('presetOptions').style.display = 'none';
                
                // Clear data
                layers = [];
                updateLayersTable();
                
                // Hide results
                document.getElementById('resultsSection').style.display = 'none';
                document.getElementById('printBtn').style.display = 'none';
                document.getElementById('saveBtn').style.display = 'none';
                
                // Clear image
                document.getElementById('partImage').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                
                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                document.getElementById('canvasInfo').textContent = '‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "CALCULATE" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Layout';
                
                // Reset global variables
                calculationResults = null;
                layoutResult = null;
                selectedPreset = null;
            }
        }
    </script>
</body>
</html>

